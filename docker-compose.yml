services:
  ci-runner-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: ci-runner-dev
    volumes:
      # Mount source code for hot-reloading
      - ./crates:/app/crates:ro
      - ./Cargo.toml:/app/Cargo.toml:ro
      - ./Cargo.lock:/app/Cargo.lock:ro
      # Mount config and secrets
      - ./config.yaml:/app/config.yaml:ro
      - ./secrets:/app/secrets:ro
      # Mount Docker socket for container execution
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount workspaces and cache directories
      # Use Docker volume for workspaces to allow mounting into job containers (Docker Desktop Mac requirement)
      - ci-workspaces:/app/workspaces
      - ci-cache:/app/cache
      # Mount target directory for faster builds (optional)
      - ci_runner_target:/app/target
    environment:
      - RUST_LOG=info
      - CI_CONFIG=/app/config.yaml
      - GS_SERVICE_TOKEN=${GS_SERVICE_TOKEN:-dummy_token}
      - CARGO_TARGET_DIR=/app/target
    ports:
      - "8080:8080"  # HTTP API (job submission, status, replay/retry, SSE streams)
      - "9090:9090"  # Prometheus metrics endpoint
    networks:
      - ci-network
    command: cargo watch --ignore "workspaces/**" --ignore "cache/**" --ignore "target/**" -x "run --bin ci_runner"
    restart: unless-stopped
    # Health check (optional)
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

volumes:
  ci_runner_target:
  ci-workspaces:
  ci-cache:

networks:
  ci-network:
    driver: bridge
    name: ci-network

