# CI Runner Configuration File
# This is a dummy/example configuration for local development

server:
  host: "0.0.0.0"
  port: 8080
  metrics_port: 9090

git_server:
  base_url: ""
  service_token_path: ""
  api_timeout: 30  # seconds

executor:
  max_concurrent_jobs: 10
  workspace_root: "/app/workspaces"
  cache_root: "/app/cache"
  
  docker:
    socket: "unix:///var/run/docker.sock"
    registry_auth: ""
    network: "ci-network"
    network_mode: "bridge"
  
  resources:
    cpu_limit: 2.0
    memory_limit: "4GB"
    storage_limit: "10GB"
    pids_limit: 1024
  
  timeouts:
    default: 3600  # 1 hour in seconds
    max: 21600  # 6 hours in seconds
    git_clone: 600  # 10 minutes in seconds

log_streamer:
  git_server:
    base_url: ""
    endpoint: "/api/v1/ci/jobs/{job_id}/logs"
    auth_token_env: "GS_SERVICE_TOKEN"
    timeout: 10  # seconds
  
  buffer:
    size: 4096
    flush_interval: 1  # seconds
    max_retries: 3
  
  rate_limit:
    max_bytes_per_second: "1MB"
    burst_size: "5MB"

security:
  secret_backend: "file"  # vault | file | env
  vault_addr: ""
  vault_token_path: ""
  seccomp_profile: ""
  apparmor_profile: ""
  network:
    isolation: "per_job"
    block_metadata: true

logging:
  level: "info"
  format: "json"
  output: "stdout"

metrics:
  enabled: true
  port: 9090
  path: "/metrics"

# Job storage configuration
# Supports in-memory (default) or Redis for persistence
store:
  store_type: "memory"  # memory | redis
  redis_url: "redis://localhost:6379"  # Only used if store_type is redis
  redis_prefix: "ci_runner"  # Key prefix for Redis keys
  max_history: 1000  # Maximum number of jobs to keep in history (for in-memory store)

# Authentication and authorization
# API key authentication for job submission and management endpoints
auth:
  enabled: false  # Set to true to enable API key authentication
  api_keys: []  # List of API keys (or use api_key_file)
  api_key_file: null  # Path to file containing API keys (one per line)
  rate_limit_per_minute: 60  # Rate limit per API key

# Artifact storage configuration
# Artifacts are stored in the cache_root/artifacts directory
# Artifact retention policies can be configured per job

# New Features:
# - Job Replay/Retry: POST /api/v1/jobs/{job_id}/replay and /retry endpoints
# - Real-time Updates: GET /api/v1/jobs/{job_id}/stream (Server-Sent Events)
# - Conditional Steps: Configure in runner.yaml with 'if', 'when', and 'retry' fields
# - OpenAPI Docs: GET /api-docs/openapi.json and /api-docs (Scalar UI)

