# Example: Compiling Go Binary
# This runner configuration builds a Go application binary
# 
# Prerequisites:
# - Go project with go.mod
# - Optional: CGO dependencies may require additional build tools
#
# Usage:
# Place this file as `runner.yaml` in your Go project root

image:
  name: "golang"
  tag: "1.21-alpine"
  pull_policy: "IfNotPresent"

on:
  push:
    - "main"
    - "develop"
  tag:
    - "v*"

global_env:
  CGO_ENABLED: "0"
  GOOS: "linux"
  GOARCH: "amd64"

timeout: 1800  # 30 minutes

steps:
  setup:
    type: "pre"
    scripts:
      - go version
      - go env
      - go mod download
      - go mod verify

  vet:
    type: "exec"
    scripts:
      - go vet ./...
    continue_on_error: false

  fmt_check:
    type: "exec"
    scripts:
      - |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "Code is not formatted. Run 'go fmt ./...'"
          gofmt -s -d .
          exit 1
        fi
    continue_on_error: false

  test:
    type: "exec"
    scripts:
      - go test -v -race -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html
    continue_on_error: false
    timeout: 600  # 10 minutes

  build_linux_amd64:
    type: "exec"
    scripts:
      - |
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        
        go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILD_TIME -X main.Commit=$COMMIT" \
          -o bin/app-linux-amd64 \
          ./cmd/app
    envs:
      GOOS: "linux"
      GOARCH: "amd64"
    continue_on_error: false

  build_linux_arm64:
    type: "exec"
    scripts:
      - |
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        
        go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILD_TIME -X main.Commit=$COMMIT" \
          -o bin/app-linux-arm64 \
          ./cmd/app
    envs:
      GOOS: "linux"
      GOARCH: "arm64"
    continue_on_error: false

  build_darwin_amd64:
    type: "exec"
    scripts:
      - |
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        
        go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILD_TIME -X main.Commit=$COMMIT" \
          -o bin/app-darwin-amd64 \
          ./cmd/app
    envs:
      GOOS: "darwin"
      GOARCH: "amd64"
    continue_on_error: false

  build_windows_amd64:
    type: "exec"
    scripts:
      - |
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        
        go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILD_TIME -X main.Commit=$COMMIT" \
          -o bin/app-windows-amd64.exe \
          ./cmd/app
    envs:
      GOOS: "windows"
      GOARCH: "amd64"
    continue_on_error: false

  checksum:
    type: "exec"
    scripts:
      - |
        cd bin
        sha256sum app-* > checksums.txt || shasum -a 256 app-* > checksums.txt
        cat checksums.txt
    continue_on_error: false
    when: "on_success"

  upload_artifacts:
    type: "post"
    scripts:
      - |
        echo "Build artifacts:"
        ls -lh bin/
        echo ""
        echo "Checksums:"
        cat bin/checksums.txt || true
    when: "always"

